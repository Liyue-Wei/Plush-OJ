<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Plush::OJ</title>
        <link rel="stylesheet" href="style_Judge.css">
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    </head>

    <body>
        <div class="header-mask"></div>
        <div class="header">
            <div class="logo">Plush::OJ</div>
            <nav class="nav">
                <a href="Home.html">首頁</a>
                <span id="user-info"></span>
            </nav>
        </div>

        <div class="main-container fade-in">
            <div class="left-column">
                <!-- 題目內容區 -->
            </div>

            <div class="right-column">
                <div class="right-top">
                    <textarea class="full-width-textarea" placeholder=""></textarea>
                    <script>
                        const textarea = document.querySelector('.full-width-textarea');
                        textarea.addEventListener('keydown', function (e) {
                            if (e.key === 'Tab') {
                                e.preventDefault(); 
                                const start = this.selectionStart;
                                const end = this.selectionEnd;
                                this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                                this.selectionStart = this.selectionEnd = start + 4;
                            }
                        });
                    </script>
                </div>

                <div class="right-bottom">
                    <button class="right-bottom-btn" id="submit-btn">Submit</button>
                    <button class="right-bottom-btn">Test</button>
                    <button class="left-bottom-btn">Output</button>
                    <button class="left-bottom-btn">Console</button>
                    <button class="left-bottom-btn">History</button>
                    <select class="dropdown-menu">
                        <option value="C">C</option>
                        <option value="CPP">C++</option>
                        <option value="CS">C#</option>
                        <option value="PY">Python</option>
                        <option value="JAVA">Java</option>
                        <option value="JS">JavaScript</option>
                        <option value="RS">Rust</option>
                        <option value="KT">Kotlin</option>
                        <option value="R">R</option>
                        <option value="GO">Go</option>
                        <option value="JL">Julia</option>                        
                    </select>
                    <textarea class="console-textarea" readonly placeholder=""></textarea>
                    <!-- console -->
                </div>
            </div>
        </div>

        <script>
            function getCookie(name) {
                const value = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
                return value ? value.pop() : '';
            }

            const account = getCookie('account');
            if (!account) {
                alert('請先登入！');
                window.location.href = 'Login.html';
            }

            const userInfo = document.getElementById('user-info');
            if (userInfo) {
                userInfo.innerHTML = `${account} | <a href="#" onclick="logout()">登出</a>`;
            }

            function logout() {
                document.cookie = 'account=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                location.reload();
            }

            function getQueryParam(name) {
                const url = new URL(window.location.href);
                return url.searchParams.get(name);
            }

            const qn = getQueryParam('qn');
            const leftColumn = document.querySelector('.left-column');
            if (qn) {
                fetch(`/question?qn=${encodeURIComponent(qn)}`)
                    .then(res => res.ok ? res.text() : Promise.reject('找不到題目'))
                    .then(md => {
                        leftColumn.innerHTML = marked.parse(md);
                    })
                    .catch(err => {
                        leftColumn.innerText = err;
                    });
            } else {
                leftColumn.innerText = "未指定題號";
            }

            document.getElementById('submit-btn').addEventListener('click', async function () {
                const code = document.querySelector('.full-width-textarea').value;
                const lang = document.querySelector('.dropdown-menu').value;
                const consoleArea = document.querySelector('.console-textarea');
                if (!qn || !account || !code.trim()) {
                    alert('請確認已登入、選擇題號並輸入程式碼');
                    return;
                }
                alert('已送出，正在進行評分');
                
                const payload = [
                    `account=${encodeURIComponent(account)}`,
                    `qn=${encodeURIComponent(qn)}`,
                    `lang=${encodeURIComponent(lang)}`,
                    `code=${encodeURIComponent(code)}`
                ].join('\n');
                try {
                    const res = await fetch('/judge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain; charset=UTF-8' },
                        body: payload
                    });
                    const text = await res.text();
                    consoleArea.value = text;
                    if (text.includes('Wrong Answer')) {
                        alert('WA: 答案錯誤');
                    } else if (text.includes('Compile Error')) {
                        alert('CE: 編譯錯誤');
                    } else if (text.includes('Prohibited Header Detected')) {
                        alert('RF: 禁止標頭');
                    } else if (text.includes('Time Limit Exceeded')) {
                        alert('TLE: 超時');
                    } else if (text.includes('Memory Limit Exceeded')) {
                        alert('MLE: 記憶體超限');
                    } else if (text.includes('Unsupported Language')) {
                        alert('Unsupported Language: 不支援的語言');
                    } else if (text.includes('Unexpected System Error')) {
                        alert('Unexpected System Error: 系統錯誤');
                    } else if (text.includes('AC') || text.includes('Accepted')) {
                        alert('Accepted!');
                    }
                } catch (e) {
                    consoleArea.value = '系統錯誤，請稍後再試';
                    alert('系統錯誤，請稍後再試');
                }
            });
        </script>
    </body>
</html>